@page "/bots"

@using LionFire.Mvvm
@using LionFire.Trading.Automation

<!--
    Example: Workspace Document List View using ObservableDataView

    This demonstrates the automatic pattern for displaying workspace documents.
    The component handles service resolution, VM creation, and reactive updates.
-->

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <MudText Typo="Typo.h3" Class="mb-4">Trading Bots</MudText>

    <ObservableDataView @ref="ItemsEditor"
                        DataServiceProvider="WorkspaceServices"
                        TKey="string"
                        TValue="BotEntity"
                        TValueVM="BotVM"
                        AllowedEditModes="EditMode.All"
                        ReadOnly="false"
                        CreatableTypes="@(new[] { typeof(BotEntity) })">
        <Columns>
            <!-- Navigation column -->
            <TemplateColumn T="BotVM">
                <HeaderTemplate>Status</HeaderTemplate>
                <CellTemplate>
                    <MudLink Href="@($"/bots/{context.Item.Key}")">
                        <MudIcon Icon="@Icons.Material.Outlined.Circle"
                                 Color="@(context.Item.Value.Enabled ? Color.Success : Color.Default)" />
                    </MudLink>
                </CellTemplate>
            </TemplateColumn>

            <!-- Toggle switch column -->
            <TemplateColumn T="BotVM">
                <HeaderTemplate>Enabled</HeaderTemplate>
                <CellTemplate>
                    @if (context.Item?.Value != null)
                    {
                        <MudSwitch T="bool"
                                   @bind-Value="context.Item.Value.Enabled"
                                   Color="Color.Primary"
                                   Size="Size.Small" />
                    }
                </CellTemplate>
            </TemplateColumn>

            <!-- Standard property columns -->
            <PropertyColumn T="BotVM" TProperty="string"
                            Property="x => x.Value.Exchange" Title="Exchange" />
            <PropertyColumn T="BotVM" TProperty="string"
                            Property="x => x.Value.Symbol" Title="Symbol" />
            <PropertyColumn T="BotVM" TProperty="string"
                            Property="x => x.Value.Name" />

            <!-- Computed property from VM -->
            <PropertyColumn Property="x => x.AD" Title="Avg DD" T="BotVM" TProperty="double?" />

            <PropertyColumn T="BotVM" TProperty="string"
                            Property="x => x.Value.Comments" />
        </Columns>

        <!-- Optional: Expandable row content -->
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">@context.Item.Value.Name</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudText><b>Exchange:</b> @context.Item.Value.Exchange</MudText>
                    <MudText><b>Enabled:</b> @context.Item.Value.Enabled</MudText>
                    <MudText><b>Comments:</b> @context.Item.Value.Comments</MudText>
                </MudCardContent>
            </MudCard>
        </ChildRowContent>

        <!-- Optional: Right-click context menu -->
        <ContextMenu>
            <MudMenuItem Icon="@Icons.Material.Filled.Delete">
                Delete @context.Value.Name
            </MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.FileCopy">
                Duplicate @context.Value.Name
            </MudMenuItem>
        </ContextMenu>
    </ObservableDataView>
</MudContainer>

@code {
    /// <summary>
    /// CRITICAL: WorkspaceServices provides workspace-scoped IObservableReader/Writer
    /// These services are NOT in the root DI container!
    /// </summary>
    [CascadingParameter(Name = "WorkspaceServices")]
    public IServiceProvider? WorkspaceServices { get; set; }

    ObservableDataView<string, BotEntity, BotVM>? ItemsEditor { get; set; }
}
